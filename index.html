<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warfare 2050</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: none;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }
        
        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .hud {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #0ff;
            font-size: 20px;
            text-shadow: 0 0 10px #0ff;
            z-index: 10;
            pointer-events: none;
        }
        
        .hud div {
            margin-bottom: 8px;
        }
        
        .powerup-display {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #0ff;
            font-size: 18px;
            text-shadow: 0 0 10px #0ff;
            z-index: 10;
            pointer-events: none;
        }
        
        .powerup-item {
            background: rgba(0, 100, 150, 0.5);
            border: 2px solid #0ff;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .bottom-hud {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #0ff;
            font-size: 24px;
            text-shadow: 0 0 10px #0ff;
            z-index: 10;
            pointer-events: none;
            display: flex;
            gap: 40px;
        }
        
        .health-bar {
            width: 300px;
            height: 30px;
            background: #222;
            border: 3px solid #0ff;
            position: relative;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(to right, #f00, #0f0);
            transition: width 0.3s;
        }
        
        .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #fff;
            text-shadow: 2px 2px 4px #000;
        }
        
        .menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: default;
        }
        
        .menu-screen.hidden {
            display: none;
        }
        
        .menu-title {
            font-size: 64px;
            color: #0ff;
            text-shadow: 0 0 30px #0ff;
            margin-bottom: 30px;
            letter-spacing: 8px;
        }
        
        .menu-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .menu-btn {
            background: rgba(0, 150, 200, 0.5);
            border: 3px solid #0aa;
            color: #fff;
            padding: 15px 40px;
            font-size: 24px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .menu-btn:hover {
            background: rgba(0, 200, 255, 0.7);
            border-color: #0ff;
            transform: scale(1.05);
        }
        
        .level-select {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 40px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .level-btn {
            width: 90px;
            height: 90px;
            background: rgba(0, 100, 150, 0.5);
            border: 3px solid #0aa;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .level-btn:hover {
            background: rgba(0, 150, 200, 0.7);
            border-color: #0ff;
            transform: scale(1.1);
        }
        
        .level-btn.locked {
            background: rgba(50, 50, 50, 0.5);
            border-color: #555;
            cursor: not-allowed;
            color: #666;
        }
        
        .level-btn.locked:hover {
            transform: none;
        }
        
        .reset-btn {
            background: #f00;
            border: 3px solid #f00;
            color: #fff;
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            font-family: inherit;
            margin-top: 20px;
        }
        
        .reset-btn:hover {
            background: #a00;
        }
        
        .shop {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 20, 40, 0.95);
            border: 3px solid #0ff;
            padding: 30px;
            display: none;
            z-index: 100;
            box-shadow: 0 0 30px #0ff;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            cursor: default;
        }
        
        .shop.active {
            display: block;
        }
        
        .shop h2 {
            color: #0ff;
            text-align: center;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .weapon-item, .skin-item {
            background: rgba(0, 100, 150, 0.3);
            border: 2px solid #0aa;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .weapon-item:hover, .skin-item:hover {
            background: rgba(0, 150, 200, 0.5);
            border-color: #0ff;
        }
        
        .weapon-item.owned, .skin-item.owned {
            border-color: #0f0;
        }
        
        .weapon-item.equipped, .skin-item.equipped {
            background: rgba(0, 255, 100, 0.3);
            border-color: #0f0;
        }
        
        .weapon-name, .skin-name {
            color: #fff;
            font-size: 18px;
            font-weight: bold;
        }
        
        .weapon-stats {
            color: #aaa;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .weapon-price, .skin-price {
            color: #ff0;
            font-size: 16px;
            margin-top: 5px;
        }
        
        .close-shop {
            background: #f00;
            border: 2px solid #f00;
            color: #fff;
            padding: 10px 20px;
            margin-top: 20px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-family: inherit;
        }
        
        .close-shop:hover {
            background: #a00;
        }
        
        .skin-preview {
            width: 50px;
            height: 50px;
            display: inline-block;
            margin-right: 15px;
            vertical-align: middle;
            border: 2px solid #666;
        }
        
        .level-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 50, 0, 0.95);
            border: 4px solid #0f0;
            padding: 40px;
            display: none;
            z-index: 100;
            text-align: center;
            box-shadow: 0 0 40px #0f0;
            cursor: default;
        }
        
        .level-complete.active {
            display: block;
        }
        
        .level-complete h2 {
            color: #0f0;
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        .level-complete button {
            background: #0f0;
            border: none;
            color: #000;
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            font-family: inherit;
            margin: 10px;
        }
        
        .level-complete button:hover {
            background: #0a0;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #0ff;
            font-size: 14px;
            text-align: right;
            text-shadow: 0 0 5px #0ff;
            pointer-events: none;
        }
        
        .crosshair {
            position: fixed;
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 1000;
        }
        
        .crosshair::before {
            content: '';
            position: absolute;
            width: 3px;
            height: 20px;
            background: #0ff;
            box-shadow: 0 0 8px #0ff;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        
        .crosshair::after {
            content: '';
            position: absolute;
            width: 3px;
            height: 20px;
            background: #0ff;
            box-shadow: 0 0 8px #0ff;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
        }
        
        .crosshair-left {
            position: absolute;
            width: 20px;
            height: 3px;
            background: #0ff;
            box-shadow: 0 0 8px #0ff;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .crosshair-right {
            position: absolute;
            width: 20px;
            height: 3px;
            background: #0ff;
            box-shadow: 0 0 8px #0ff;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .crosshair-dot {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #f00;
            border-radius: 50%;
            box-shadow: 0 0 6px #f00;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="crosshair" id="crosshair">
        <div class="crosshair-left"></div>
        <div class="crosshair-right"></div>
        <div class="crosshair-dot"></div>
    </div>
    
    <div class="menu-screen" id="menuScreen">
        <div class="menu-title">WARFARE 2050</div>
        <div class="menu-buttons">
            <button class="menu-btn" onclick="showLevelSelect()">PLAY</button>
            <button class="menu-btn" onclick="showSkinShop()">SKINS</button>
        </div>
        <div id="levelSelectContainer" style="display: none;">
            <div class="level-select" id="levelSelect"></div>
        </div>
        <button class="reset-btn" onclick="resetGame()">RESET GAME</button>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <div class="hud">
        <div>LEVEL: <span id="level">1</span></div>
        <div>CREDITS: <span id="credits">0</span></div>
        <div>WEAPON: <span id="weapon">PISTOL</span></div>
    </div>
    
    <div class="powerup-display" id="powerupDisplay"></div>
    
    <div class="bottom-hud">
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="margin-bottom: 5px;">HEALTH</div>
            <div class="health-bar">
                <div class="health-fill" id="healthFill" style="width: 100%;"></div>
                <div class="health-text" id="healthText">100 / 100</div>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="margin-bottom: 5px;">AMMO</div>
            <div style="font-size: 32px;"><span id="ammo">30</span> / <span id="maxAmmo">30</span></div>
        </div>
    </div>
    
    <div class="shop" id="shop">
        <h2>WEAPON SHOP</h2>
        <div id="weaponList"></div>
        <button class="close-shop" onclick="closeShop()">CLOSE [TAB]</button>
    </div>
    
    <div class="shop" id="skinShop">
        <h2>SKIN SHOP</h2>
        <div id="skinList"></div>
        <button class="close-shop" onclick="closeSkinShop()">CLOSE</button>
    </div>
    
    <div class="level-complete" id="levelComplete">
        <h2>LEVEL COMPLETE!</h2>
        <div style="color: #fff; font-size: 20px; margin: 20px 0;">
            <div>CREDITS EARNED: <span id="levelCredits">0</span></div>
        </div>
        <button onclick="nextLevel()">NEXT LEVEL</button>
        <button onclick="backToMenu()">MAIN MENU</button>
    </div>
    
    <div class="controls">
        WASD: Move | MOUSE: Aim<br>
        HOLD LEFT CLICK: Shoot | R: Reload | TAB: Shop
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        const WEAPONS = {
            pistol: { name: 'PISTOL', damage: 20, fireRate: 250, ammo: 30, price: 0, sprite: 6, owned: true, color: '#ffff00', pattern: 'single' },
            smg: { name: 'SMG', damage: 15, fireRate: 80, ammo: 50, price: 200, sprite: 8, owned: false, color: '#ffaa00', pattern: 'auto' },
            shotgun: { name: 'SHOTGUN', damage: 50, fireRate: 600, ammo: 8, price: 400, sprite: 10, owned: false, color: '#ff8800', pattern: 'shotgun' },
            rifle: { name: 'RIFLE', damage: 40, fireRate: 150, ammo: 30, price: 600, sprite: 12, owned: false, color: '#ff6600', pattern: 'burst3' },
            autoShotgun: { name: 'AUTO SHOTGUN', damage: 45, fireRate: 100, ammo: 20, price: 1000, sprite: 12, owned: false, color: '#ff4400', pattern: 'autoShotgun' },
            lmg: { name: 'LMG', damage: 25, fireRate: 60, ammo: 100, price: 1200, sprite: 14, owned: false, color: '#ffdd00', pattern: 'auto' },
            heavySniper: { name: 'HEAVY SNIPER', damage: 500, fireRate: 1000, ammo: 5, price: 1500, sprite: 18, owned: false, color: '#00ffff', pattern: 'single', pierce: true },
            plasma: { name: 'PLASMA RIFLE', damage: 55, fireRate: 120, ammo: 40, price: 1800, sprite: 14, owned: false, color: '#00ff00', pattern: 'auto' },
            laser: { name: 'LASER CANNON', damage: 90, fireRate: 400, ammo: 25, price: 2200, sprite: 16, owned: false, color: '#ff00ff', pattern: 'beam' },
            railgun: { name: 'RAILGUN', damage: 300, fireRate: 1200, ammo: 5, price: 2600, sprite: 18, owned: false, color: '#00ffff', pattern: 'single', pierce: true },
            minigun: { name: 'MINIGUN', damage: 22, fireRate: 40, ammo: 200, price: 3000, sprite: 16, owned: false, color: '#ff4400', pattern: 'auto' },
            flamethrower: { name: 'FLAMETHROWER', damage: 25, fireRate: 25, ammo: 250, price: 3400, sprite: 14, owned: false, color: '#ff6600', pattern: 'flame' },
            rocket: { name: 'ROCKET LAUNCHER', damage: 250, fireRate: 1200, ammo: 7, price: 3800, sprite: 18, owned: false, color: '#ff2200', pattern: 'rocket' },
            tesla: { name: 'TESLA GUN', damage: 60, fireRate: 250, ammo: 30, price: 4200, sprite: 16, owned: false, color: '#00aaff', pattern: 'chain' },
            ion: { name: 'ION BLASTER', damage: 90, fireRate: 300, ammo: 20, price: 4600, sprite: 18, owned: false, color: '#0088ff', pattern: 'burst2' },
            devastator: { name: 'DEVASTATOR', damage: 120, fireRate: 600, ammo: 15, price: 5000, sprite: 20, owned: false, color: '#ff0088', pattern: 'single', pierce: true },
            pulse: { name: 'PULSE CANNON', damage: 75, fireRate: 300, ammo: 35, price: 5400, sprite: 16, owned: false, color: '#ff00aa', pattern: 'burst3' },
            quantum: { name: 'QUANTUM DESTROYER', damage: 100, fireRate: 550, ammo: 18, price: 5800, sprite: 20, owned: false, color: '#aa00ff', pattern: 'burst2' },
            annihilator: { name: 'ANNIHILATOR', damage: 160, fireRate: 1000, ammo: 8, price: 6500, sprite: 22, owned: false, color: '#ff0088', pattern: 'single', pierce: true },
            void: { name: 'VOID CANNON', damage: 130, fireRate: 700, ammo: 12, price: 7000, sprite: 20, owned: false, color: '#8800ff', pattern: 'burst2' },
            hyperBlaster: { name: 'HYPER BLASTER', damage: 85, fireRate: 150, ammo: 60, price: 7500, sprite: 18, owned: false, color: '#00ff88', pattern: 'auto' },
            photon: { name: 'PHOTON BEAMER', damage: 95, fireRate: 350, ammo: 30, price: 8000, sprite: 18, owned: false, color: '#ff4400', pattern: 'beam' },
            neutron: { name: 'NEUTRON CANNON', damage: 200, fireRate: 400, ammo: 15, price: 9000, sprite: 24, owned: false, color: '#00ffaa', pattern: 'single', pierce: true },
            omega: { name: 'OMEGA WEAPON', damage: 1000, fireRate: 1000, ammo: 10, price: 12000, sprite: 26, owned: false, color: '#ffffff', pattern: 'single', pierce: true }
        };

        const SKINS = {
            default: { name: 'DEFAULT', color: '#1a1a1a', visor: '#00ffff', price: 0, owned: true },
            red: { name: 'CRIMSON WARRIOR', color: '#8a0000', visor: '#ff0000', price: 500, owned: false },
            blue: { name: 'COBALT STRIKER', color: '#00008a', visor: '#0088ff', price: 500, owned: false },
            green: { name: 'EMERALD OPERATIVE', color: '#008a00', visor: '#00ff00', price: 500, owned: false },
            purple: { name: 'VOID ASSASSIN', color: '#4a0080', visor: '#ff00ff', price: 800, owned: false },
            gold: { name: 'GOLDEN ELITE', color: '#aa8800', visor: '#ffff00', price: 1200, owned: false },
            silver: { name: 'STEEL COMMANDER', color: '#888888', visor: '#ffffff', price: 1000, owned: false },
            orange: { name: 'INFERNO SOLDIER', color: '#cc4400', visor: '#ff8800', price: 700, owned: false },
            pink: { name: 'NEON GHOST', color: '#ff0088', visor: '#ff00ff', price: 900, owned: false },
            cyan: { name: 'ARCTIC RECON', color: '#008888', visor: '#00ffff', price: 800, owned: false }
        };

        const game = {
            player: {
                x: 200,
                y: 300,
                width: 16,
                height: 24,
                vx: 0,
                vy: 0,
                health: 100,
                maxHealth: 100,
                credits: 0,
                facing: 1,
                onGround: false,
                weapon: 'pistol',
                ammo: 30,
                reloading: false,
                skin: 'default',
                powerups: {
                    warpSpeed: { active: false, timer: 0 },
                    doubleDamage: { active: false, timer: 0 },
                    jetBoots: { active: false, timer: 0 }
                }
            },
            mouse: { x: 0, y: 0, down: false },
            bullets: [],
            enemies: [],
            enemyBullets: [],
            particles: [],
            items: [],
            powerups: [],
            platforms: [],
            level: 1,
            maxLevel: 25,
            unlockedLevels: 1,
            score: 0,
            paused: false,
            gravity: 0.45,
            keys: {},
            lastShot: 0,
            burstCount: 0,
            burstTimer: 0,
            enemySpawnTimer: 0,
            enemySpawnDelay: 4000,
            bossSpawned: false,
            levelComplete: false,
            enemiesKilled: 0,
            enemiesToKill: 15,
            gameStarted: false,
            groundLevel: 0
        };

        document.addEventListener('mousemove', (e) => {
            game.mouse.x = e.clientX;
            game.mouse.y = e.clientY;
            
            const crosshair = document.getElementById('crosshair');
            crosshair.style.left = (e.clientX - 20) + 'px';
            crosshair.style.top = (e.clientY - 20) + 'px';
            
            if (game.gameStarted && !game.paused) {
                game.player.facing = e.clientX > game.player.x ? 1 : -1;
            }
        });

        document.addEventListener('mousedown', (e) => {
            if (e.button === 0) {
                game.mouse.down = true;
            }
        });

        document.addEventListener('mouseup', (e) => {
            if (e.button === 0) {
                game.mouse.down = false;
                game.burstCount = 0;
            }
        });

        function loadGame() {
            const saved = localStorage.getItem('warfare2050');
            if (saved) {
                const data = JSON.parse(saved);
                game.unlockedLevels = data.unlockedLevels || 1;
                game.player.credits = data.credits || 0;
                game.player.skin = data.skin || 'default';
                Object.keys(WEAPONS).forEach(key => {
                    if (data.weapons && data.weapons[key]) {
                        WEAPONS[key].owned = true;
                    }
                });
                Object.keys(SKINS).forEach(key => {
                    if (data.skins && data.skins[key]) {
                        SKINS[key].owned = true;
                    }
                });
            }
        }

        function saveGame() {
            const data = {
                unlockedLevels: game.unlockedLevels,
                credits: game.player.credits,
                skin: game.player.skin,
                weapons: {},
                skins: {}
            };
            Object.keys(WEAPONS).forEach(key => {
                if (WEAPONS[key].owned) {
                    data.weapons[key] = true;
                }
            });
            Object.keys(SKINS).forEach(key => {
                if (SKINS[key].owned) {
                    data.skins[key] = true;
                }
            });
            localStorage.setItem('warfare2050', JSON.stringify(data));
        }

        function resetGame() {
            if (confirm('Reset all progress?')) {
                localStorage.removeItem('warfare2050');
                location.reload();
            }
        }

        function showLevelSelect() {
            document.getElementById('levelSelectContainer').style.display = 'block';
            const container = document.getElementById('levelSelect');
            container.innerHTML = '';
            
            for (let i = 1; i <= game.maxLevel; i++) {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                btn.textContent = i;
                
                if (i > game.unlockedLevels) {
                    btn.classList.add('locked');
                    btn.disabled = true;
                } else {
                    btn.onclick = () => startLevel(i);
                }
                
                container.appendChild(btn);
            }
        }

        function showSkinShop() {
            document.getElementById('skinShop').classList.add('active');
            renderSkinShop();
        }

        function closeSkinShop() {
            document.getElementById('skinShop').classList.remove('active');
        }

        function renderSkinShop() {
            const skinList = document.getElementById('skinList');
            skinList.innerHTML = '';
            
            Object.keys(SKINS).forEach(key => {
                const s = SKINS[key];
                const div = document.createElement('div');
                div.className = 'skin-item';
                
                if (s.owned) {
                    div.classList.add('owned');
                }
                if (game.player.skin === key) {
                    div.classList.add('equipped');
                }
                
                const preview = document.createElement('canvas');
                preview.width = 50;
                preview.height = 50;
                preview.className = 'skin-preview';
                const pctx = preview.getContext('2d');
                pctx.fillStyle = s.color;
                pctx.fillRect(15, 20, 20, 24);
                pctx.fillStyle = s.visor;
                pctx.fillRect(18, 24, 14, 4);
                pctx.fillRect(22, 24, 6, 8);
                
                div.appendChild(preview);
                
                const info = document.createElement('div');
                info.style.display = 'inline-block';
                info.innerHTML = `
                    <div class="skin-name">${s.name} ${game.player.skin === key ? '[EQUIPPED]' : ''}</div>
                    <div class="skin-price">${s.owned ? (game.player.skin === key ? 'EQUIPPED' : 'CLICK TO EQUIP') : 'CREDITS: ' + s.price}</div>
                `;
                div.appendChild(info);
                
                div.onclick = () => {
                    if (s.owned) {
                        game.player.skin = key;
                        saveGame();
                        renderSkinShop();
                    } else if (game.player.credits >= s.price) {
                        game.player.credits -= s.price;
                        s.owned = true;
                        game.player.skin = key;
                        saveGame();
                        renderSkinShop();
                    }
                };
                
                skinList.appendChild(div);
            });
        }

        function startLevel(level) {
            game.level = level;
            game.gameStarted = true;
            document.getElementById('menuScreen').classList.add('hidden');
            initLevel();
        }

        function backToMenu() {
            document.getElementById('levelComplete').classList.remove('active');
            document.getElementById('menuScreen').classList.remove('hidden');
            document.getElementById('levelSelectContainer').style.display = 'none';
            game.gameStarted = false;
            game.levelComplete = false;
        }

        function initLevel() {
            game.platforms = [];
            game.enemies = [];
            game.bullets = [];
            game.enemyBullets = [];
            game.items = [];
            game.powerups = [];
            game.particles = [];
            game.bossSpawned = false;
            game.levelComplete = false;
            game.enemiesKilled = 0;
            game.bossSpawned = false;
            game.levelComplete = false;
            game.enemiesKilled = 0;
            game.enemiesToKill = 15 + game.level * 8;
            game.enemySpawnDelay = Math.max(1800, 4000 - game.level * 100);
            game.enemySpawnTimer = 0;
            
            const w = canvas.width;
            const h = canvas.height;
            
            const groundLevels = [60, 80, 50, 90, 70, 55, 85, 65, 75, 60, 70, 85, 55, 95, 65, 75, 80, 60, 70, 90, 55, 75, 85, 65, 80];
            game.groundLevel = groundLevels[game.level - 1];
            
            game.player.x = w / 2;
            game.player.y = h - game.groundLevel - game.player.height - 5;
            game.player.health = game.player.maxHealth;
            game.player.ammo = WEAPONS[game.player.weapon].ammo;
            game.player.vy = 0;
            game.player.onGround = true;
            game.player.powerups = {
                warpSpeed: { active: false, timer: 0 },
                doubleDamage: { active: false, timer: 0 },
                jetBoots: { active: false, timer: 0 }
            };
            
            game.platforms.push({ x: 0, y: h - game.groundLevel, width: w, height: game.groundLevel });
            
            const layouts = [
                [[0.15, 100], [0.35, 140], [0.55, 100], [0.75, 130], [0.25, 80], [0.65, 160], [0.45, 120], [0.85, 90]],
                [[0.1, 120], [0.3, 90], [0.5, 150], [0.7, 110], [0.9, 130], [0.4, 80], [0.6, 100], [0.2, 140]],
                [[0.12, 140], [0.28, 100], [0.44, 130], [0.6, 90], [0.76, 150], [0.36, 160], [0.68, 120], [0.84, 80]],
                [[0.15, 110], [0.32, 150], [0.48, 90], [0.64, 140], [0.8, 100], [0.24, 120], [0.56, 130], [0.88, 160]],
                [[0.1, 90], [0.25, 130], [0.4, 160], [0.55, 110], [0.7, 140], [0.85, 100], [0.33, 120], [0.63, 90]],
                [[0.18, 130], [0.36, 100], [0.54, 150], [0.72, 120], [0.27, 90], [0.45, 140], [0.63, 80], [0.81, 110]],
                [[0.1, 150], [0.28, 110], [0.46, 90], [0.64, 140], [0.82, 100], [0.37, 130], [0.55, 160], [0.73, 120]],
                [[0.15, 100], [0.3, 140], [0.45, 80], [0.6, 130], [0.75, 110], [0.23, 160], [0.53, 90], [0.83, 150]],
                [[0.12, 120], [0.27, 90], [0.42, 160], [0.57, 100], [0.72, 140], [0.87, 110], [0.35, 130], [0.65, 80]],
                [[0.2, 140], [0.38, 100], [0.56, 130], [0.74, 90], [0.29, 110], [0.47, 150], [0.65, 120], [0.83, 160]],
                [[0.1, 100], [0.25, 140], [0.4, 90], [0.55, 130], [0.7, 110], [0.85, 150], [0.33, 160], [0.63, 120]],
                [[0.15, 130], [0.32, 90], [0.49, 140], [0.66, 100], [0.83, 120], [0.24, 110], [0.58, 160], [0.74, 80]],
                [[0.1, 110], [0.28, 150], [0.46, 100], [0.64, 130], [0.82, 90], [0.37, 140], [0.55, 120], [0.73, 160]],
                [[0.18, 90], [0.34, 130], [0.5, 110], [0.66, 150], [0.82, 100], [0.26, 140], [0.58, 80], [0.74, 120]],
                [[0.12, 140], [0.3, 100], [0.48, 130], [0.66, 90], [0.84, 150], [0.21, 110], [0.54, 160], [0.72, 120]],
                [[0.15, 120], [0.33, 160], [0.51, 90], [0.69, 130], [0.87, 110], [0.24, 100], [0.6, 140], [0.78, 150]],
                [[0.1, 90], [0.27, 140], [0.44, 110], [0.61, 150], [0.78, 100], [0.36, 130], [0.53, 160], [0.86, 120]],
                [[0.14, 150], [0.31, 110], [0.48, 90], [0.65, 140], [0.82, 120], [0.23, 130], [0.57, 100], [0.74, 160]],
                [[0.1, 130], [0.28, 90], [0.46, 150], [0.64, 110], [0.82, 140], [0.19, 100], [0.55, 120], [0.73, 160]],
                [[0.16, 100], [0.34, 140], [0.52, 90], [0.7, 130], [0.88, 110], [0.25, 160], [0.61, 150], [0.79, 120]],
                [[0.1, 110], [0.26, 150], [0.42, 100], [0.58, 140], [0.74, 90], [0.9, 130], [0.34, 120], [0.66, 160]],
                [[0.15, 140], [0.32, 100], [0.49, 130], [0.66, 90], [0.83, 150], [0.24, 110], [0.58, 160], [0.75, 120]],
                [[0.1, 90], [0.28, 130], [0.46, 110], [0.64, 160], [0.82, 100], [0.37, 140], [0.55, 150], [0.73, 120]],
                [[0.18, 120], [0.36, 160], [0.54, 90], [0.72, 130], [0.27, 110], [0.45, 140], [0.63, 100], [0.81, 150]],
                [[0.1, 150], [0.25, 110], [0.4, 90], [0.55, 140], [0.7, 100], [0.85, 130], [0.33, 160], [0.63, 120]]
            ];
            
            const layout = layouts[game.level - 1];
            layout.forEach(([xPercent, height]) => {
                const platW = 90 + Math.random() * 60;
                const platX = w * xPercent - platW / 2;
                const platY = h - game.groundLevel - height;
                game.platforms.push({ x: platX, y: platY, width: platW, height: 15 });
            });
        }

        document.addEventListener('keydown', (e) => {
            game.keys[e.key.toLowerCase()] = true;
            
            if (e.key.toLowerCase() === 'r') {
                reload();
            }
            if (e.key === 'Tab') {
                e.preventDefault();
                if (game.gameStarted && !game.levelComplete) {
                    toggleShop();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            game.keys[e.key.toLowerCase()] = false;
        });

        function shoot() {
            if (game.paused || game.levelComplete || !game.gameStarted) return;
            
            const weapon = WEAPONS[game.player.weapon];
            const now = Date.now();
            
            if (now - game.lastShot < weapon.fireRate || game.player.ammo <= 0 || game.player.reloading) return;
            
            const dx = game.mouse.x - game.player.x;
            const dy = game.mouse.y - game.player.y;
            const angle = Math.atan2(dy, dx);
            const speed = 15;
            
            const damageMultiplier = game.player.powerups.doubleDamage.active ? 2 : 1;
            const hasDoubleDamage = game.player.powerups.doubleDamage.active;
            
            if (weapon.pattern === 'burst3' || weapon.pattern === 'burst2') {
                const burstSize = weapon.pattern === 'burst3' ? 3 : 2;
                if (game.burstCount === 0) {
                    game.lastShot = now;
                    game.player.ammo--;
                }
                
                game.bullets.push({
                    x: game.player.x + game.player.width / 2,
                    y: game.player.y + 10,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    width: 6,
                    height: 2,
                    damage: weapon.damage * damageMultiplier,
                    color: weapon.color,
                    pierce: weapon.pierce,
                    doubleDamage: hasDoubleDamage
                });
                
                game.burstCount++;
                if (game.burstCount >= burstSize) {
                    game.burstCount = 0;
                }
                return;
            }
            
            game.lastShot = now;
            game.player.ammo--;
            
            if (weapon.pattern === 'flame') {
                for (let i = 0; i < 15; i++) {
                    const spreadAngle = angle + (Math.random() - 0.5) * 0.4;
                    const particleSpeed = 8 + Math.random() * 6;
                    game.particles.push({
                        x: game.player.x + game.player.width / 2,
                        y: game.player.y + 10,
                        vx: Math.cos(spreadAngle) * particleSpeed,
                        vy: Math.sin(spreadAngle) * particleSpeed,
                        life: 20 + Math.random() * 15,
                        color: Math.random() > 0.5 ? '#ff6600' : '#ffaa00',
                        isFlame: true,
                        damage: (weapon.damage / 15) * damageMultiplier
                    });
                }
                return;
            }
            
            if (weapon.pattern === 'shotgun') {
                for (let i = 0; i < 7; i++) {
                    const spreadAngle = angle + (Math.random() - 0.5) * 0.35;
                    game.bullets.push({
                        x: game.player.x + game.player.width / 2,
                        y: game.player.y + 10,
                        vx: Math.cos(spreadAngle) * (speed + (Math.random() - 0.5) * 4),
                        vy: Math.sin(spreadAngle) * (speed + (Math.random() - 0.5) * 4),
                        width: 4,
                        height: 2,
                        damage: weapon.damage * damageMultiplier / 7,
                        color: weapon.color,
                        doubleDamage: hasDoubleDamage
                    });
                }
                return;
            }
            
            if (weapon.pattern === 'autoShotgun') {
                for (let i = 0; i < 5; i++) {
                    const spreadAngle = angle + (Math.random() - 0.5) * 0.3;
                    game.bullets.push({
                        x: game.player.x + game.player.width / 2,
                        y: game.player.y + 10,
                        vx: Math.cos(spreadAngle) * (speed + (Math.random() - 0.5) * 3),
                        vy: Math.sin(spreadAngle) * (speed + (Math.random() - 0.5) * 3),
                        width: 4,
                        height: 2,
                        damage: weapon.damage * damageMultiplier / 5,
                        color: weapon.color,
                        doubleDamage: hasDoubleDamage
                    });
                }
                return;
            }
            
            if (weapon.pattern === 'chain') {
                game.bullets.push({
                    x: game.player.x + game.player.width / 2,
                    y: game.player.y + 10,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    width: 6,
                    height: 2,
                    damage: weapon.damage * damageMultiplier,
                    color: weapon.color,
                    chain: true,
                    chained: [],
                    doubleDamage: hasDoubleDamage
                });
                return;
            }
            
            if (weapon.pattern === 'rocket') {
                game.bullets.push({
                    x: game.player.x + game.player.width / 2,
                    y: game.player.y + 10,
                    vx: Math.cos(angle) * (speed * 0.7),
                    vy: Math.sin(angle) * (speed * 0.7),
                    width: 8,
                    height: 8,
                    damage: weapon.damage * damageMultiplier,
                    color: weapon.color,
                    isRocket: true,
                    doubleDamage: hasDoubleDamage
                });
                return;
            }
            
            if (weapon.pattern === 'beam') {
                for (let i = 0; i < 3; i++) {
                    game.bullets.push({
                        x: game.player.x + game.player.width / 2 + Math.cos(angle) * i * 15,
                        y: game.player.y + 10 + Math.sin(angle) * i * 15,
                        vx: Math.cos(angle) * (speed * 1.5),
                        vy: Math.sin(angle) * (speed * 1.5),
                        width: 4,
                        height: 4,
                        damage: weapon.damage * damageMultiplier / 3,
                        color: weapon.color,
                        pierce: true,
                        doubleDamage: hasDoubleDamage
                    });
                }
                return;
            }
            
            game.bullets.push({
                x: game.player.x + game.player.width / 2,
                y: game.player.y + 10,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                width: 6,
                height: 2,
                damage: weapon.damage * damageMultiplier,
                color: weapon.color,
                pierce: weapon.pierce,
                doubleDamage: hasDoubleDamage
            });

            for (let i = 0; i < 5; i++) {
                game.particles.push({
                    x: game.player.x + game.player.width / 2,
                    y: game.player.y + 10,
                    vx: (Math.random() - 0.5) * 6 + Math.cos(angle) * 3,
                    vy: (Math.random() - 0.5) * 6 + Math.sin(angle) * 3,
                    life: 15,
                    color: weapon.color,
                    isFlame: false
                });
            }
        }

        function reload() {
            const weapon = WEAPONS[game.player.weapon];
            if (game.player.ammo < weapon.ammo && !game.player.reloading) {
                game.player.reloading = true;
                setTimeout(() => {
                    game.player.ammo = weapon.ammo;
                    game.player.reloading = false;
                }, 1500);
            }
        }

        function spawnEnemy(isBoss = false) {
            const side = Math.random() > 0.5 ? 1 : 0;
            const levelMultiplier = game.level * 0.3;
            const groundY = canvas.height - game.groundLevel - (isBoss ? 48 : 24);
            
            game.enemies.push({
                x: side === 1 ? canvas.width - 50 : 50,
                y: groundY,
                width: isBoss ? 32 : 16,
                height: isBoss ? 48 : 24,
                vx: (side === 1 ? -1 : 1) * (1.2 + levelMultiplier),
                vy: 0,
                health: isBoss ? (300 + game.level * 40) : (40 + game.level * 8),
                maxHealth: isBoss ? (300 + game.level * 40) : (40 + game.level * 8),
                lastShot: 0,
                shootDelay: isBoss ? 600 : 1800 + Math.random() * 800,
                onGround: true,
                isBoss: isBoss,
                facing: side === 1 ? -1 : 1,
                jumpCooldown: 0,
                bossType: isBoss ? (game.level % 5) : 0
            });
        }

        function spawnPowerup(x, y) {
            const rand = Math.random();
            if (rand > 0.8) return;
            
            let type;
            if (rand < 0.2) {
                const types = ['warpSpeed', 'doubleDamage', 'jetBoots'];
                type = types[Math.floor(Math.random() * types.length)];
            } else if (rand < 0.6) {
                type = 'health';
            } else {
                type = 'credits';
            }
            
            if (type === 'health' || type === 'credits') {
                game.items.push({
                    x: x,
                    y: y,
                    type: type,
                    vy: -5,
                    lifetime: 600
                });
            } else {
                game.powerups.push({
                    x: x,
                    y: y,
                    type: type,
                    vy: -5,
                    lifetime: 600
                });
            }
        }

        function updatePlayer() {
            if (game.paused || game.levelComplete || !game.gameStarted) return;
            
            const p = game.player;
            
            Object.keys(p.powerups).forEach(key => {
                if (p.powerups[key].active) {
                    p.powerups[key].timer -= 16;
                    if (p.powerups[key].timer <= 0) {
                        p.powerups[key].active = false;
                        p.powerups[key].timer = 0;
                    }
                }
            });
            
            const speedMult = p.powerups.warpSpeed.active ? 2 : 1;
            const jumpMult = p.powerups.warpSpeed.active ? 2 : 1;
            
            p.vx = 0;
            if (game.keys['a'] || game.keys['arrowleft']) {
                p.vx = -5 * speedMult;
            }
            if (game.keys['d'] || game.keys['arrowright']) {
                p.vx = 5 * speedMult;
            }
            
            if (p.powerups.warpSpeed.active) {
                for (let i = 0; i < 2; i++) {
                    game.particles.push({
                        x: p.x + p.width / 2 + (Math.random() - 0.5) * 10,
                        y: p.y + p.height / 2 + (Math.random() - 0.5) * 10,
                        vx: (Math.random() - 0.5) * 3,
                        vy: (Math.random() - 0.5) * 3,
                        life: 20,
                        color: '#00aaff',
                        isFlame: false
                    });
                }
            }
            
            if (p.powerups.jetBoots.active && (game.keys['w'] || game.keys[' '])) {
                p.vy = -8;
                for (let i = 0; i < 3; i++) {
                    game.particles.push({
                        x: p.x + p.width / 2 + (Math.random() - 0.5) * 10,
                        y: p.y + p.height,
                        vx: (Math.random() - 0.5) * 3,
                        vy: 3 + Math.random() * 3,
                        life: 20,
                        color: '#ff8800',
                        isFlame: false
                    });
                }
            } else {
                if ((game.keys['w'] || game.keys['arrowup']) && p.onGround) {
                    p.vy = -13 * jumpMult;
                    p.onGround = false;
                }
            }
            
            if (!p.onGround) {
                p.vy += game.gravity;
            }
            
            p.x += p.vx;
            p.y += p.vy;
            
            p.onGround = false;
            
            game.platforms.forEach(plat => {
                if (p.x + p.width > plat.x && p.x < plat.x + plat.width &&
                    p.y + p.height >= plat.y && p.y + p.height <= plat.y + Math.abs(p.vy) + 10 && p.vy >= 0) {
                    p.y = plat.y - p.height;
                    p.vy = 0;
                    p.onGround = true;
                }
            });
            
            p.x = Math.max(0, Math.min(canvas.width - p.width, p.x));
            
            if (game.mouse.down) {
                shoot();
            }
        }

        function updateEnemies() {
            if (game.paused || game.levelComplete || !game.gameStarted) return;
            
            const now = Date.now();
            
            for (let i = game.enemies.length - 1; i >= 0; i--) {
                const e = game.enemies[i];
                
                const distToPlayer = game.player.x - e.x;
                const distY = game.player.y - e.y;
                
                if (distY < -50 && e.onGround && e.jumpCooldown <= 0) {
                    const reachablePlatforms = game.platforms.filter(p => {
                        const platDist = Math.abs(p.x - e.x);
                        return platDist < 150 && p.y < e.y && p.y > e.y - 200;
                    });
                    
                    if (reachablePlatforms.length > 0) {
                        e.vy = -11;
                        e.jumpCooldown = 60;
                        e.onGround = false;
                    }
                }
                
                if (e.jumpCooldown > 0) e.jumpCooldown--;
                
                if (Math.abs(distToPlayer) > 80) {
                    e.vx = (distToPlayer > 0 ? 1 : -1) * (e.isBoss ? 2 : 1.3) * (1 + game.level * 0.2);
                    e.facing = distToPlayer > 0 ? 1 : -1;
                } else {
                    e.vx *= 0.8;
                }
                
                e.x += e.vx;
                
                if (!e.onGround) {
                    e.vy += game.gravity;
                }
                
                e.y += e.vy;
                e.onGround = false;
                
                game.platforms.forEach(plat => {
                    if (e.x + e.width > plat.x && e.x < plat.x + plat.width &&
                        e.y + e.height >= plat.y && e.y + e.height <= plat.y + Math.abs(e.vy) + 10 && e.vy >= 0) {
                        e.y = plat.y - e.height;
                        e.vy = 0;
                        e.onGround = true;
                    }
                });
                
                if (e.x < -50 || e.x > canvas.width + 50) {
                    e.vx *= -1;
                    e.facing *= -1;
                }
                
                if (now - e.lastShot > e.shootDelay && Math.abs(e.x - game.player.x) < 500) {
                    e.lastShot = now;
                    const angle = Math.atan2(game.player.y - e.y, game.player.x - e.x);
                    game.enemyBullets.push({
                        x: e.x + e.width / 2,
                        y: e.y + (e.isBoss ? 20 : 10),
                        vx: Math.cos(angle) * 8,
                        vy: Math.sin(angle) * 8,
                        width: 6,
                        height: 2,
                        damage: e.isBoss ? 12 : 7
                    });
                }
            }
            
            if (!game.bossSpawned) {
                game.enemySpawnTimer += 16;
                if (game.enemySpawnTimer > game.enemySpawnDelay) {
                    game.enemySpawnTimer = 0;
                    if (game.enemiesKilled >= game.enemiesToKill) {
                        spawnEnemy(true);
                        game.bossSpawned = true;
                    } else {
                        spawnEnemy(false);
                    }
                }
            }
        }

        function updateBullets() {
            if (game.paused || game.levelComplete || !game.gameStarted) return;
            
            for (let i = game.bullets.length - 1; i >= 0; i--) {
                const b = game.bullets[i];
                b.x += b.vx;
                b.y += b.vy;
                
                if (b.x < -50 || b.x > canvas.width + 50 || b.y < -50 || b.y > canvas.height + 50) {
                    game.bullets.splice(i, 1);
                    continue;
                }
                
                let hitEnemy = false;
                for (let j = game.enemies.length - 1; j >= 0; j--) {
                    const e = game.enemies[j];
                    if (b.x < e.x + e.width && b.x + b.width > e.x &&
                        b.y < e.y + e.height && b.y + b.height > e.y) {
                        
                        if (b.isRocket) {
                            const explosionRadius = 100;
                            game.enemies.forEach(enemy => {
                                const dist = Math.sqrt((enemy.x + enemy.width/2 - b.x) ** 2 + (enemy.y + enemy.height/2 - b.y) ** 2);
                                if (dist < explosionRadius) {
                                    const damageFactor = 1 - (dist / explosionRadius);
                                    enemy.health -= b.damage * damageFactor;
                                }
                            });
                            
                            for (let k = 0; k < 20; k++) {
                                game.particles.push({
                                    x: b.x,
                                    y: b.y,
                                    vx: (Math.random() - 0.5) * 12,
                                    vy: (Math.random() - 0.5) * 12,
                                    life: 30,
                                    color: Math.random() > 0.5 ? '#ff6600' : '#ff0000',
                                    isFlame: false
                                });
                            }
                            game.bullets.splice(i, 1);
                            hitEnemy = true;
                        } else {
                            e.health -= b.damage;
                        }
                        
                        if (b.chain && !b.chained.includes(j)) {
                            b.chained.push(j);
                            const nearbyEnemies = game.enemies.filter((enemy, idx) => {
                                if (idx === j || b.chained.includes(idx)) return false;
                                const dist = Math.sqrt((enemy.x - e.x) ** 2 + (enemy.y - e.y) ** 2);
                                return dist < 150;
                            });
                            if (nearbyEnemies.length > 0) {
                                const target = nearbyEnemies[0];
                                const newAngle = Math.atan2(target.y - e.y, target.x - e.x);
                                b.x = e.x;
                                b.y = e.y;
                                b.vx = Math.cos(newAngle) * 15;
                                b.vy = Math.sin(newAngle) * 15;
                            }
                        }
                        
                        if (!b.pierce && !b.chain && !b.isRocket) {
                            game.bullets.splice(i, 1);
                        }
                        
                        for (let k = 0; k < 10; k++) {
                            game.particles.push({
                                x: b.x,
                                y: b.y,
                                vx: (Math.random() - 0.5) * 6,
                                vy: (Math.random() - 0.5) * 6,
                                life: 30,
                                color: '#ff0000',
                                isFlame: false
                            });
                        }
                        
                        if (e.health <= 0) {
                            game.enemies.splice(j, 1);
                            game.enemiesKilled++;
                            game.score += e.isBoss ? 1000 : 100;
                            
                            spawnPowerup(e.x, e.y);
                            
                            if (e.isBoss) {
                                game.levelComplete = true;
                                if (game.level >= game.unlockedLevels && game.level < game.maxLevel) {
                                    game.unlockedLevels = game.level + 1;
                                }
                                saveGame();
                                document.getElementById('levelComplete').classList.add('active');
                                document.getElementById('levelCredits').textContent = game.score;
                            }
                        }
                        
                        if (!b.pierce && !b.chain) break;
                    }
                }
                
                if (b.isRocket && hitEnemy) {
                    break;
                }
            }
            
            for (let i = game.enemyBullets.length - 1; i >= 0; i--) {
                const b = game.enemyBullets[i];
                b.x += b.vx;
                b.y += b.vy;
                
                if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) {
                    game.enemyBullets.splice(i, 1);
                    continue;
                }
                
                const p = game.player;
                if (b.x < p.x + p.width && b.x + b.width > p.x &&
                    b.y < p.y + p.height && b.y + b.height > p.y) {
                    p.health -= b.damage;
                    game.enemyBullets.splice(i, 1);
                    
                    if (p.health <= 0) {
                        alert('GAME OVER! Final Score: ' + game.score);
                        backToMenu();
                    }
                }
            }
        }

        function updateItems() {
            if (game.paused || game.levelComplete || !game.gameStarted) return;
            
            for (let i = game.items.length - 1; i >= 0; i--) {
                const item = game.items[i];
                
                item.lifetime--;
                if (item.lifetime <= 0) {
                    game.items.splice(i, 1);
                    continue;
                }
                
                if (!item.onGround) {
                    item.vy += game.gravity * 0.5;
                }
                item.y += item.vy;
                
                game.platforms.forEach(plat => {
                    if (item.y + 8 >= plat.y && item.y <= plat.y + 20 &&
                        item.x + 8 > plat.x && item.x < plat.x + plat.width && item.vy >= 0) {
                        item.y = plat.y - 8;
                        item.vy = 0;
                        item.onGround = true;
                    }
                });
                
                const p = game.player;
                if (Math.abs(item.x - p.x) < 25 && Math.abs(item.y - p.y) < 25) {
                    if (item.type === 'credits') {
                        game.player.credits += 30 + game.level * 10;
                        saveGame();
                    } else {
                        game.player.health = Math.min(game.player.maxHealth, game.player.health + 25);
                    }
                    game.items.splice(i, 1);
                }
                
                if (item.lifetime < 120 && Math.floor(item.lifetime / 10) % 2 === 0) {
                    item.hidden = true;
                } else {
                    item.hidden = false;
                }
            }
        }

        function updatePowerups() {
            if (game.paused || game.levelComplete || !game.gameStarted) return;
            
            for (let i = game.powerups.length - 1; i >= 0; i--) {
                const powerup = game.powerups[i];
                
                powerup.lifetime--;
                if (powerup.lifetime <= 0) {
                    game.powerups.splice(i, 1);
                    continue;
                }
                
                if (!powerup.onGround) {
                    powerup.vy += game.gravity * 0.5;
                }
                powerup.y += powerup.vy;
                
                game.platforms.forEach(plat => {
                    if (powerup.y + 12 >= plat.y && powerup.y <= plat.y + 20 &&
                        powerup.x + 12 > plat.x && powerup.x < plat.x + plat.width && powerup.vy >= 0) {
                        powerup.y = plat.y - 12;
                        powerup.vy = 0;
                        powerup.onGround = true;
                    }
                });
                
                const p = game.player;
                if (Math.abs(powerup.x - p.x) < 25 && Math.abs(powerup.y - p.y) < 25) {
                    p.powerups[powerup.type].active = true;
                    p.powerups[powerup.type].timer = 30000;
                    game.powerups.splice(i, 1);
                }
                
                if (powerup.lifetime < 120 && Math.floor(powerup.lifetime / 10) % 2 === 0) {
                    powerup.hidden = true;
                } else {
                    powerup.hidden = false;
                }
            }
        }

        function updateParticles() {
            for (let i = game.particles.length - 1; i >= 0; i--) {
                const p = game.particles[i];
                p.x += p.vx;
                p.y += p.vy;
                
                if (!p.isFlame) {
                    p.vy += 0.2;
                }
                
                p.life--;
                
                if (p.isFlame) {
                    for (let j = game.enemies.length - 1; j >= 0; j--) {
                        const e = game.enemies[j];
                        if (p.x > e.x && p.x < e.x + e.width &&
                            p.y > e.y && p.y < e.y + e.height) {
                            e.health -= p.damage;
                            
                            if (e.health <= 0) {
                                game.enemies.splice(j, 1);
                                game.enemiesKilled++;
                                game.score += e.isBoss ? 1000 : 100;
                                
                                spawnPowerup(e.x, e.y);
                                
                                if (e.isBoss) {
                                    game.levelComplete = true;
                                    if (game.level >= game.unlockedLevels && game.level < game.maxLevel) {
                                        game.unlockedLevels = game.level + 1;
                                    }
                                    saveGame();
                                    document.getElementById('levelComplete').classList.add('active');
                                    document.getElementById('levelCredits').textContent = game.score;
                                }
                            }
                            break;
                        }
                    }
                }
                
                if (p.life <= 0) {
                    game.particles.splice(i, 1);
                }
            }
        }

        function drawRect(x, y, w, h, color) {
            ctx.fillStyle = color;
            ctx.fillRect(Math.floor(x), Math.floor(y), w, h);
        }

        function drawPlayer() {
            const p = game.player;
            const skin = SKINS[p.skin];
            
            if (p.powerups.warpSpeed.active) {
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00aaff';
            }
            
            drawRect(p.x + 3, p.y + 8, 10, 12, skin.color);
            drawRect(p.x + 4, p.y + 9, 2, 2, '#0a0a0a');
            drawRect(p.x + 10, p.y + 9, 2, 2, '#0a0a0a');
            
            drawRect(p.x + 2, p.y + 8, 3, 4, skin.color);
            drawRect(p.x + 11, p.y + 8, 3, 4, skin.color);
            
            drawRect(p.x + 4, p.y + 1, 8, 7, skin.color);
            drawRect(p.x + 5, p.y + 3, 6, 2, skin.visor);
            drawRect(p.x + 7, p.y + 3, 2, 4, skin.visor);
            
            const weapon = WEAPONS[p.weapon];
            const angle = Math.atan2(game.mouse.y - p.y, game.mouse.x - p.x);
            const weaponLen = weapon.sprite;
            const weaponX = p.x + p.width / 2 + Math.cos(angle) * 8;
            const weaponY = p.y + 12 + Math.sin(angle) * 8;
            
            ctx.save();
            ctx.translate(weaponX, weaponY);
            ctx.rotate(angle);
            drawRect(0, -1, weaponLen, 3, '#444');
            drawRect(weaponLen - 2, -1, 2, 3, '#888');
            ctx.restore();
            
            drawRect(p.x + 5, p.y + 20, 3, 4, skin.color);
            drawRect(p.x + 8, p.y + 20, 3, 4, skin.color);
            
            ctx.shadowBlur = 0;
        }

        function drawEnemy(e) {
            if (e.isBoss) {
                switch(e.bossType) {
                    case 0:
                        drawRect(e.x + 4, e.y + 16, e.width - 8, 20, '#8a0000');
                        drawRect(e.x + 2, e.y + 16, 4, 8, '#5a0000');
                        drawRect(e.x + e.width - 6, e.y + 16, 4, 8, '#5a0000');
                        drawRect(e.x + 6, e.y + 18, 4, 4, '#ff0000');
                        drawRect(e.x + e.width - 10, e.y + 18, 4, 4, '#ff0000');
                        drawRect(e.x + 6, e.y + 4, e.width - 12, 12, '#5a0000');
                        drawRect(e.x + 8, e.y + 8, e.width - 16, 4, '#ff0000');
                        break;
                    case 1:
                        drawRect(e.x + 4, e.y + 16, e.width - 8, 20, '#002080');
                        drawRect(e.x + 2, e.y + 16, 4, 8, '#001050');
                        drawRect(e.x + e.width - 6, e.y + 16, 4, 8, '#001050');
                        drawRect(e.x + 6, e.y + 18, 4, 4, '#00ffff');
                        drawRect(e.x + e.width - 10, e.y + 18, 4, 4, '#00ffff');
                        drawRect(e.x + 6, e.y + 4, e.width - 12, 12, '#001050');
                        drawRect(e.x + 8, e.y + 8, e.width - 16, 4, '#00ffff');
                        break;
                    case 2:
                        drawRect(e.x + 4, e.y + 16, e.width - 8, 20, '#2a5a00');
                        drawRect(e.x + 2, e.y + 16, 4, 8, '#1a3a00');
                        drawRect(e.x + e.width - 6, e.y + 16, 4, 8, '#1a3a00');
                        drawRect(e.x + 6, e.y + 18, 4, 4, '#00ff00');
                        drawRect(e.x + e.width - 10, e.y + 18, 4, 4, '#00ff00');
                        drawRect(e.x + 6, e.y + 4, e.width - 12, 12, '#1a3a00');
                        drawRect(e.x + 8, e.y + 8, e.width - 16, 4, '#00ff00');
                        break;
                    case 3:
                        drawRect(e.x + 4, e.y + 16, e.width - 8, 20, '#5a005a');
                        drawRect(e.x + 2, e.y + 16, 4, 8, '#3a003a');
                        drawRect(e.x + e.width - 6, e.y + 16, 4, 8, '#3a003a');
                        drawRect(e.x + 6, e.y + 18, 4, 4, '#ff00ff');
                        drawRect(e.x + e.width - 10, e.y + 18, 4, 4, '#ff00ff');
                        drawRect(e.x + 6, e.y + 4, e.width - 12, 12, '#3a003a');
                        drawRect(e.x + 8, e.y + 8, e.width - 16, 4, '#ff00ff');
                        break;
                    case 4:
                        drawRect(e.x + 4, e.y + 16, e.width - 8, 20, '#5a5a00');
                        drawRect(e.x + 2, e.y + 16, 4, 8, '#3a3a00');
                        drawRect(e.x + e.width - 6, e.y + 16, 4, 8, '#3a3a00');
                        drawRect(e.x + 6, e.y + 18, 4, 4, '#ffff00');
                        drawRect(e.x + e.width - 10, e.y + 18, 4, 4, '#ffff00');
                        drawRect(e.x + 6, e.y + 4, e.width - 12, 12, '#3a3a00');
                        drawRect(e.x + 8, e.y + 8, e.width - 16, 4, '#ffff00');
                        break;
                }
                
                const weaponLen = 14;
                const weaponY = e.y + 20;
                drawRect(e.x + (e.facing > 0 ? e.width : -weaponLen + 4), weaponY, weaponLen, 4, '#555');
                drawRect(e.x + (e.facing > 0 ? e.width + weaponLen - 4 : -weaponLen + 4), weaponY, 4, 4, '#888');
                
                drawRect(e.x + 6, e.y + 36, 6, 12, '#2a2a2a');
                drawRect(e.x + e.width - 12, e.y + 36, 6, 12, '#2a2a2a');
            } else {
                const color = '#6a3030';
                const darkColor = '#4a2020';
                const lightColor = '#8a5050';
                
                drawRect(e.x + 3, e.y + 8, e.width - 6, 12, color);
                drawRect(e.x + 4, e.y + 9, 2, 2, darkColor);
                drawRect(e.x + 10, e.y + 9, 2, 2, darkColor);
                drawRect(e.x + 2, e.y + 8, 3, 4, darkColor);
                drawRect(e.x + e.width - 5, e.y + 8, 3, 4, darkColor);
                drawRect(e.x + 4, e.y + 2, e.width - 8, 6, color);
                drawRect(e.x + 5, e.y + 4, e.width - 10, 2, lightColor);
                
                const weaponLen = 7;
                const weaponY = e.y + 11;
                drawRect(e.x + (e.facing > 0 ? e.width : -weaponLen + 3), weaponY, weaponLen, 3, '#555');
                drawRect(e.x + (e.facing > 0 ? e.width + weaponLen - 3 : -weaponLen + 3), weaponY, 3, 3, '#777');
                
                drawRect(e.x + 5, e.y + 20, 3, 4, color);
                drawRect(e.x + e.width - 8, e.y + 20, 3, 4, color);
            }
            
            const barWidth = e.width;
            const healthPercent = e.health / e.maxHealth;
            drawRect(e.x, e.y - 8, barWidth, 5, '#222');
            const barColor = e.isBoss ? '#ff0000' : (healthPercent > 0.5 ? '#00ff00' : '#ffaa00');
            drawRect(e.x + 1, e.y - 7, (barWidth - 2) * healthPercent, 3, barColor);
        }

        function draw() {
            if (!game.gameStarted) return;
            
            const skyColors = [
                ['#1a1a3e', '#2a2a5e'], ['#3e1a1a', '#5e2a2a'], ['#1a3e1a', '#2a5e2a'],
                ['#3e3e1a', '#5e5e2a'], ['#3e1a3e', '#5e2a5e'], ['#1a2a3e', '#2a4a5e'],
                ['#3e2a1a', '#5e4a2a'], ['#2a3e1a', '#4a5e2a'], ['#3e2a3e', '#5e4a5e'],
                ['#1a1a1a', '#3a3a3a'], ['#1a3a3a', '#2a5a5a'], ['#3a1a3a', '#5a2a5a'],
                ['#3a3a1a', '#5a5a2a'], ['#2a1a3a', '#4a2a5a'], ['#1a3a2a', '#2a5a4a'],
                ['#3a2a1a', '#5a4a2a'], ['#2a3a2a', '#4a5a4a'], ['#3a1a2a', '#5a2a4a'],
                ['#1a2a3a', '#2a4a5a'], ['#2a3a1a', '#4a5a2a'], ['#3a2a2a', '#5a4a4a'],
                ['#1a3a1a', '#2a5a2a'], ['#3a1a1a', '#5a2a2a'], ['#2a2a3a', '#4a4a5a'],
                ['#0a0a1a', '#1a1a3a']
            ];
            const colors = skyColors[(game.level - 1) % skyColors.length];
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(1, colors[1]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            game.platforms.forEach(plat => {
                drawRect(plat.x, plat.y, plat.width, plat.height, '#1a1a1a');
                drawRect(plat.x, plat.y, plat.width, 3, '#0ff');
                drawRect(plat.x, plat.y + 3, plat.width, 2, '#088');
            });
            
            game.items.forEach(item => {
                if (item.hidden) return;
                
                if (item.type === 'credits') {
                    drawRect(item.x, item.y, 10, 10, '#ffff00');
                    drawRect(item.x + 2, item.y + 2, 6, 6, '#ffaa00');
                    drawRect(item.x + 3, item.y + 3, 4, 4, '#ff8800');
                } else {
                    drawRect(item.x, item.y, 10, 10, '#00ff00');
                    drawRect(item.x + 1, item.y + 1, 8, 8, '#00cc00');
                    drawRect(item.x + 3, item.y + 1, 4, 8, '#fff');
                    drawRect(item.x + 1, item.y + 3, 8, 4, '#fff');
                }
            });
            
            game.powerups.forEach(powerup => {
                if (powerup.hidden) return;
                
                let color;
                if (powerup.type === 'warpSpeed') color = '#0088ff';
                else if (powerup.type === 'doubleDamage') color = '#ff0000';
                else color = '#ff8800';
                
                drawRect(powerup.x, powerup.y, 12, 12, color);
                drawRect(powerup.x + 2, powerup.y + 2, 8, 8, color);
                drawRect(powerup.x + 3, powerup.y + 3, 6, 6, '#ffffff');
            });
            
            game.bullets.forEach(b => {
                if (b.doubleDamage) {
                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(Math.floor(b.x - 1), Math.floor(b.y - 1), b.width + 2, b.height + 2);
                }
                ctx.shadowBlur = 5;
                ctx.shadowColor = b.color;
                drawRect(b.x, b.y, b.width, b.height, b.color);
                ctx.shadowBlur = 0;
            });
            
            game.enemyBullets.forEach(b => {
                drawRect(b.x, b.y, b.width, b.height, '#ff4400');
            });
            
            game.particles.forEach(p => {
                ctx.globalAlpha = p.life / 30;
                if (p.isFlame) {
                    drawRect(p.x, p.y, 4, 4, p.color);
                } else {
                    drawRect(p.x, p.y, 3, 3, p.color);
                }
                ctx.globalAlpha = 1;
            });
            
            drawPlayer();
            game.enemies.forEach(drawEnemy);
            
            if (game.player.reloading) {
                ctx.fillStyle = '#ffff00';
                ctx.font = '18px monospace';
                ctx.shadowBlur = 5;
                ctx.shadowColor = '#ffff00';
                ctx.fillText('RELOADING...', game.player.x - 25, game.player.y - 15);
                ctx.shadowBlur = 0;
            }
        }

        function updateHUD() {
            document.getElementById('level').textContent = game.level;
            document.getElementById('credits').textContent = game.player.credits;
            document.getElementById('weapon').textContent = WEAPONS[game.player.weapon].name;
            
            const healthPercent = (game.player.health / game.player.maxHealth) * 100;
            document.getElementById('healthFill').style.width = healthPercent + '%';
            document.getElementById('healthText').textContent = Math.max(0, Math.floor(game.player.health)) + ' / ' + game.player.maxHealth;
            
            document.getElementById('ammo').textContent = game.player.ammo;
            document.getElementById('maxAmmo').textContent = WEAPONS[game.player.weapon].ammo;
            
            const powerupDisplay = document.getElementById('powerupDisplay');
            powerupDisplay.innerHTML = '';
            
            Object.keys(game.player.powerups).forEach(key => {
                if (game.player.powerups[key].active) {
                    const div = document.createElement('div');
                    div.className = 'powerup-item';
                    const timeLeft = Math.ceil(game.player.powerups[key].timer / 1000);
                    let name = '';
                    if (key === 'warpSpeed') name = 'WARP SPEED';
                    else if (key === 'doubleDamage') name = 'DOUBLE DAMAGE';
                    else name = 'JET BOOTS';
                    div.textContent = `${name}: ${timeLeft}s`;
                    powerupDisplay.appendChild(div);
                }
            });
        }

        function toggleShop() {
            game.paused = !game.paused;
            const shop = document.getElementById('shop');
            
            if (game.paused) {
                shop.classList.add('active');
                renderShop();
            } else {
                shop.classList.remove('active');
            }
        }

        function closeShop() {
            game.paused = false;
            document.getElementById('shop').classList.remove('active');
        }

        window.closeShop = closeShop;
        window.closeSkinShop = closeSkinShop;
        window.resetGame = resetGame;
        window.showLevelSelect = showLevelSelect;
        window.showSkinShop = showSkinShop;
        window.nextLevel = nextLevel;
        window.backToMenu = backToMenu;

        function renderShop() {
            const weaponList = document.getElementById('weaponList');
            weaponList.innerHTML = '';
            
            Object.keys(WEAPONS).forEach(key => {
                const w = WEAPONS[key];
                const div = document.createElement('div');
                div.className = 'weapon-item';
                
                if (w.owned) {
                    div.classList.add('owned');
                }
                if (game.player.weapon === key) {
                    div.classList.add('equipped');
                }
                
                const fireRate = (1000 / w.fireRate).toFixed(1);
                let special = '';
                if (w.pierce) special += ' [PIERCE]';
                if (w.pattern === 'chain') special += ' [CHAIN]';
                if (w.pattern === 'burst2') special += ' [2-BURST]';
                if (w.pattern === 'burst3') special += ' [3-BURST]';
                if (w.pattern === 'rocket') special += ' [EXPLOSIVE]';
                
                div.innerHTML = `
                    <div class="weapon-name">${w.name} ${game.player.weapon === key ? '[EQUIPPED]' : ''}</div>
                    <div class="weapon-stats">DMG: ${w.damage} | FIRE RATE: ${fireRate}/s | AMMO: ${w.ammo}${special}</div>
                    <div class="weapon-price">${w.owned ? (game.player.weapon === key ? 'EQUIPPED' : 'CLICK TO EQUIP') : 'CREDITS: ' + w.price}</div>
                `;
                
                div.onclick = () => {
                    if (w.owned) {
                        game.player.weapon = key;
                        game.player.ammo = w.ammo;
                        renderShop();
                    } else if (game.player.credits >= w.price) {
                        game.player.credits -= w.price;
                        w.owned = true;
                        game.player.weapon = key;
                        game.player.ammo = w.ammo;
                        saveGame();
                        renderShop();
                    }
                };
                
                weaponList.appendChild(div);
            });
        }

        function nextLevel() {
            game.level++;
            if (game.level > game.maxLevel) {
                alert('CONGRATULATIONS! YOU COMPLETED ALL LEVELS! Final Score: ' + game.score);
                backToMenu();
                return;
            }
            
            document.getElementById('levelComplete').classList.remove('active');
            initLevel();
        }

        function gameLoop() {
            updatePlayer();
            updateEnemies();
            updateBullets();
            updateItems();
            updatePowerups();
            updateParticles();
            draw();
            updateHUD();
            requestAnimationFrame(gameLoop);
        }

        loadGame();
        gameLoop();
    </script>
</body>
</html>
